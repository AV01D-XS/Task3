name: CI/CD Pipeline

# Trigger on push to main branch or pull requests
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]  # your server runner labels

    steps:
      # Optional: Checkout workflow repo (does not overwrite server files)
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step: Deploy Docker Compose project on server
      - name: Deploy Docker Compose
        run: |
          echo "Entering project path ~/ayham/project3"
          cd ~/ayham/project3
          echo "Stopping old containers..."
          docker compose down || true
          echo "Building and starting containers..."
          docker compose up -d --build
          echo "Cleaning up unused Docker images..."
          docker image prune -af || true
          echo "Deployment complete!"
